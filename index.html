<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stargate RPG NPC Builder</title>
    
    <!-- React and Babel CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* Custom scrollbar styles */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937;
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
        
        /* Line clamp utility */
        .line-clamp-2 {
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        
        /* Range slider custom styles */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            background: transparent;
            cursor: pointer;
        }
        
        input[type="range"]::-webkit-slider-track {
            background: #4b5563;
            height: 4px;
            border-radius: 2px;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            background: #3b82f6;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            margin-top: -8px;
        }
        
        input[type="range"]::-moz-range-track {
            background: #4b5563;
            height: 4px;
            border-radius: 2px;
        }
        
        input[type="range"]::-moz-range-thumb {
            background: #3b82f6;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            border: none;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;
        
        // Icon components using inline SVGs
        const Icons = {
            ChevronDown: ({ className = "w-4 h-4" }) => (
                <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                </svg>
            ),
            Shield: ({ className = "w-4 h-4" }) => (
                <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20.618 5.984A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                </svg>
            ),
            Heart: ({ className = "w-4 h-4" }) => (
                <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                </svg>
            ),
            Zap: ({ className = "w-4 h-4" }) => (
                <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z" />
                </svg>
            ),
            Brain: ({ className = "w-4 h-4" }) => (
                <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                </svg>
            ),
            Target: ({ className = "w-4 h-4" }) => (
                <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                </svg>
            ),
            Download: ({ className = "w-4 h-4" }) => (
                <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                </svg>
            ),
            Plus: ({ className = "w-4 h-4" }) => (
                <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                </svg>
            ),
            Minus: ({ className = "w-4 h-4" }) => (
                <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20 12H4" />
                </svg>
            ),
            Search: ({ className = "w-4 h-4" }) => (
                <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
            )
        };
        
        const StargateNPCBuilder = () => {
            // Initialize state with default values
            const [npc, setNpc] = useState({
                name: '',
                race: '',
                cr: 1,
                type: '',
                abilityScores: {
                    strength: 10,
                    dexterity: 10,
                    constitution: 10,
                    intelligence: 10,
                    wisdom: 10,
                    charisma: 10
                },
                bonusAttributes: {
                    strength: '',
                    dexterity: '',
                    constitution: '',
                    intelligence: '',
                    wisdom: '',
                    charisma: ''
                },
                skillProficiencies: [],
                attackSpecialization: '',
                feats: [],
                featSelections: {},
                beastAbilities: [],
                beastAbilitySelections: {},
                hp: 0,
                ac: 10,
                profBonus: 2,
                speed: 6,
                initiative: 0
            });
            
            const [expandedCategories, setExpandedCategories] = useState({});
            const [expandedBeastCategories, setExpandedBeastCategories] = useState({});
            const [selectedFeatCategory, setSelectedFeatCategory] = useState('General');
            const [featSearchQuery, setFeatSearchQuery] = useState('');
            
            // Define all constant arrays
            const races = ['Beast', 'Human', 'Jaffa', 'NPC Race'];
            
            const beastTypes = [
                { name: 'Predator', description: 'Hunting carnivore with natural weapons' },
                { name: 'Prey', description: 'Herbivore with speed and senses' },
                { name: 'Pack Hunter', description: 'Cooperative predator with tactics' },
                { name: 'Ambush Predator', description: 'Stealth hunter with powerful first strike' },
                { name: 'Flying', description: 'Aerial creature with flight capability' },
                { name: 'Aquatic', description: 'Water-dwelling creature with swimming' },
                { name: 'Insectoid', description: 'Chitinous creature with multiple limbs' },
                { name: 'Reptilian', description: 'Scaled creature, often with natural armor' }
            ];
            
            const selectionOptions = {
                attributes: ['Strength', 'Dexterity', 'Constitution', 'Intelligence', 'Wisdom', 'Charisma'],
                environments: ['Forest', 'Plains', 'Desert', 'Arctic', 'Underwater', 'Mountains', 'Urban', 'Swamp', 'Cave'],
                senses: ['Sight', 'Hearing', 'Smell', 'Touch'],
                conditions: ['Blinded', 'Deafened', 'Stunned'],
                maneuvers: ['Disarm', 'Grapple', 'Trip/Shove'],
                combatSkills: ['Acrobatics', 'Athletics', 'Intimidation', 'Perception', 'Stealth', 'Survival']
            };

            const beastAbilitiesByCategory = {
  "Movement & Mobility": [
    { name: "Climb", description: "The beast gains a climb speed of 3m. This ability may be taken a second time, increasing the climb speed to 6m." },
    { name: "Extra Legs", description: "The beast's land speed increases by +1m and it has advantage on checks and saves to resist being knocked prone." },
    { name: "Fast", description: "Increase one of the beast's movement speeds by +3m." },
    { name: "Flight", description: "The beast gains a fly speed of 6m." },
    { name: "Flightless", description: "The beast loses its fly speed (if it had one) but takes only half damage from falling." },
    { name: "Lumbering", description: "All the beast's movement speeds are reduced by 3m, but it gains bonus hit points equal to twice its CR." },
    { name: "Move By", description: "The beast does not provoke opportunity attacks when moving out of an enemy's reach." },
    { name: "Spider Climb", description: "The beast can climb difficult surfaces, including upside down on ceilings, without needing to make checks." },
    { name: "Standing Leap", description: "The beast is always treated as having moved at least 2m when making a running jump." },
    { name: "Swimmer", description: "The beast gains a swim speed of 3m. This ability may be taken a second time, increasing the swim speed to 6m." }
  ],
  "Senses & Perception": [
    { name: "Bioluminescent", description: "The beast emits bright light in a 2m radius and dim light for an additional 2m." },
    { name: "Blindsight", description: "The beast gains blindsight out to 3m. This ability may be taken a second time to increase blindsight to 6m." },
    { name: "Darkvision", description: "The beast gains darkvision out to 6m. This ability may be taken a second time to increase darkvision to 12m." },
    { name: "Echolocation", description: "The beast gains blindsight out to 6m or doubles any existing blindsight. It cannot use this sense while deafened." },
    { name: "Keen Sense", needsSelection: "sense", description: "Choose one sense (such as sight, hearing, or smell). The beast has advantage on Perception checks using that sense." }
  ],
  "Defense & Resilience": [
    { name: "Armored", description: "The beast's AC increases by +2. This ability may be taken multiple times, and the bonuses stack." },
    { name: "Crystalline", description: "The beast's body is composed of crystal or stone. It has resistance to slashing and piercing damage but vulnerability to bludgeoning damage." },
    { name: "Relentless", description: "Once per short or long rest, when the beast would be reduced to 0 HP, it instead drops to 1 HP." },
    { name: "Sure-Footed", description: "The beast has advantage on Strength and Dexterity saves against effects that would knock it prone." },
    { name: "Tough", description: "The beast gains bonus hit points equal to its CR. This ability may be taken multiple times, and the bonuses stack." }
  ],
  "Offense & Combat": [
    { name: "Blood Frenzy", description: "The beast has advantage on melee attack rolls against targets that are injured (at or below half HP)." },
    { name: "Charge", description: "If the beast moves at least 4m straight toward a target and then hits it, it deals extra damage equal to one of its natural attack dice and forces a Strength save (DC 10) or the target is knocked prone." },
    { name: "Constrict", description: "When the beast successfully grapples a target, it automatically deals damage equal to one of its natural attacks at the end of each of the target's turns until it escapes." },
    { name: "Multiattack", description: "The beast can attack once with each of its natural weapons when it takes the Attack action (requires multiple natural weapons)." },
    { name: "Natural Weapon", description: "The beast gains an additional natural attack (such as a bite, claw, or gore). This ability may be taken multiple times." },
    { name: "Pack Tactics", description: "The beast has advantage on attack rolls against a target if an ally is within 1.5m of the target and not incapacitated." },
    { name: "Pounce", description: "If the beast moves at least 6m (20ft) straight toward a creature and hits it with a melee attack, the target must succeed on a Strength save (DC 5 + CR) or be knocked prone." },
    { name: "Powerful Attack", description: "Choose one of the beast's natural attacks. Its damage die increases to the next size (e.g., 1d8 → 1d10). This ability may be taken multiple times." },
    { name: "Superior Natural Attacks", description: "The beast's natural weapons count as having a Tech Level equal to one-fourth its CR (minimum TL 1)." },
    { name: "Venomous", description: "Choose one of the beast's natural attacks. On a hit, the target must succeed on a Constitution save (DC 10 + CR) or be poisoned. At the start of each of its turns, the poisoned target takes poison damage that scales with CR (1–4 TD). The save can be repeated at the start of each turn." },
    { name: "Webbing", description: "The beast can entangle targets in webs as a ranged or melee attack. On a hit, the target must succeed on a Dexterity save (DC 10) or be restrained for 1d4 rounds. While in contact with a web, the beast knows the exact location of any creature touching it. The beast ignores movement restrictions caused by webs." }
  ],
  "Environmental Adaptation": [
    { name: "Amphibious Breath", description: "The beast can breathe both air and water." },
    { name: "Camouflage", needsSelection: "environment", description: "Choose an environment (forest, plains, underwater, etc.). The beast has advantage on Stealth checks made in that environment." },
    { name: "Hold Breath", description: "The beast can hold its breath for up to 30 minutes." }
  ],
  "Physical Form": [
    { name: "Apex Predator", description: "The beast is a solitary, apex threat. Its hit points are doubled. It cannot benefit from other HP-increasing effects. Selecting this ability increases its CR by +1." },
    { name: "Beast of Burden", description: "The beast's carrying capacity is doubled (push, pull, lift, carry)." },
    { name: "Larger", description: "The beast increases by one size category. Its Strength increases by +2, Dexterity decreases by –2, and AC decreases by 1. Its natural attack damage scales as if it were 2 CR higher. This ability may be taken multiple times, stacking in size and attribute adjustments." },
    { name: "Swarm", description: "The beast represents a swarm of smaller creatures. It can occupy the same space as other creatures and can move through any opening large enough for one member of the swarm. It cannot regain HP or gain temporary HP." }
  ],
  "Enhancements": [
    { name: "Improved Ability", description: "Choose one beast ability that forces a saving throw. The save DC increases by +2. This ability may be taken multiple times, stacking with different abilities." },
    { name: "Improved Attribute", needsSelection: "attribute", description: "Increase one attribute of the beast by +2. This ability may be taken multiple times, stacking." },
    { name: "Mimicry", description: "The beast can mimic simple sounds it has heard, such as voices, cries, or noises. A listener can recognize them as imitations with a DC 10 Insight check." },
    { name: "Proficient", description: "The beast's proficiency bonus increases by +1, up to the maximum allowed by its final CR. This ability may be taken multiple times." },
    { name: "Skilled", needsSelection: "combatSkill", description: "The beast gains proficiency in one combat-related or physical skill (such as Athletics, Perception, Stealth, or Survival). This ability may be taken multiple times with different skills." },
    { name: "Feat", description: "The beast gains one feat of your choice (from the feat list). GM discretion may limit which feats are appropriate." }
  ]
};


            
            const featsByCategory = {
"General": [
    { name: "Ability Score Increase", cost: 7, needsSelection: "attribute", description: "Increase one ability score by +1 (to a maximum of 20)." },
    { name: "Advanced Training: Diplomat", cost: 9, requirements: "Charisma 13+, Persuasion", description: "Gain the Diplomat's Inspire ability." },
    { name: "Advanced Training: Engineer", cost: 9, requirements: "Intelligence 13+, Engineering", description: "Gain the Engineer's Jury Rig ability." },
    { name: "Advanced Training: Medic", cost: 9, requirements: "Wisdom 13+, Medicine", description: "Gain the Medic's First Aid ability." },
    { name: "Advanced Training: Scientist", cost: 9, requirements: "Intelligence 13+, Science", description: "Gain the Scientist's Eureka ability." },
    { name: "Advanced Training: Scout", cost: 9, requirements: "Constitution 13+, Survival", description: "Gain the Scout's Survivalist ability." },
    { name: "Advanced Training: Soldier", cost: 9, requirements: "Constitution 13+, Intimidation", description: "Gain the Soldier's Tactical Flexibility ability." },
    { name: "Airborne School", cost: 3, requirements: "Athletics", description: "Gain resistance to falling damage and advantage on parachute checks below 1km altitude." }
  ],
                'Combat - General': [
                    { name: 'Attack Specialist', cost: 4, requirements: 'Level 5', description: 'Double damage dice with weapon' },
                    { name: 'Attack Veteran', cost: 4, requirements: 'Level 11, Attack Specialist', description: 'Triple damage dice with weapon' },
                    { name: 'Critical Focus', cost: 5, requirements: 'Proficient with weapon', description: 'Add prof bonus to crit damage' },
                    { name: 'Critical Effect', cost: 9, needsSelection: 'condition', requirements: 'Critical Focus', description: 'Apply condition on critical' }
                ],
                'Combat - Melee': [
                    { name: 'Blind-Fighter', cost: 3, requirements: 'Perception', description: 'No disadvantage on blind melee' },
                    { name: 'Brawler', cost: 7, requirements: 'Attack Specialist', description: 'Chain melee attacks' },
                    { name: 'Defensive Art Master', cost: 5, requirements: 'Dodge, Martial Arts', description: 'Resistance vs unarmed' }
                ],
                'Combat - Ranged': [
                    { name: 'Ballistics Expert', cost: 7, requirements: 'Science', description: 'Use Int for ranged attacks' },
                    { name: 'Deadly Shot', cost: 7, requirements: 'Perception', description: 'Disadvantage for +TD damage' },
                    { name: 'Uncanny Shot', cost: 5, requirements: 'Sniper Techniques', description: 'Double long range with Sniper Techniques' }
                ],
                'Inspiration': [
                    { name: 'Calm and Collected', cost: 5, description: 'Inspired gain save advantage' },
                    { name: 'Skillful Explanations', cost: 5, description: 'Allow skill reroll' }
                ],
                'Modification': [
                    { name: 'Armorer', cost: 5, description: 'Grant armor +1 AC' },
                    { name: 'Montage', cost: 5, description: 'Reduce R&D successes needed' }
                ],
                'Procedure': [
                    { name: 'Biohazard Disposal', cost: 5, description: 'Team proficient vs disease' },
                    { name: 'Vital Organ Trauma', cost: 5, description: 'Add Wis to crit damage' }
                ],
                'Discovery': [
                    { name: 'A Moments Thought', cost: 5, description: 'Reroll failed Int/Wis check' },
                    { name: 'Social Sciences', cost: 5, requirements: 'Culture', description: 'Gain Eureka when losing DP' }
                ],
                'Field Hack': [
                    { name: 'Camouflage', cost: 5, requirements: 'Stealth', description: 'Team Stealth advantage' },
                    { name: 'Xenosurvival', cost: 5, requirements: 'Constitution 13+', description: 'Share Survivalist benefits' }
                ],
                'Tactic': [
                    { name: 'Ambush', cost: 5, description: 'Team advantage on first melee' },
                    { name: 'Rush', cost: 5, description: 'Ally can Dash' }
                ],
                'Downtime': [
                    { name: 'Armory Hound', cost: 3, description: 'Weapons start at higher Tech Level' },
                    { name: 'Virtuoso', cost: 3, description: 'Musical performance abilities' }
                ]
            };
            
            const skills = [
                'Acrobatics', 'Athletics', 'Culture', 'Deception', 'Engineering',
                'Insight', 'Intimidation', 'Investigation', 'Medicine', 'Nature',
                'Perception', 'Performance', 'Persuasion', 'Pilot', 'Science',
                'Sleight of Hand', 'Stealth', 'Survival'
            ];
            
            const weaponTypes = [
                'Common Weapons', 'Sidearms', 'Longarms', 'Shotguns',
                'Martial Arts', 'Heavy Weapons', 'Jaffa Weapons', 'Grenades'
            ];
            
            const toolTypes = [
                'Camo Kit', 'Explosives', 'Med Kit', 'Research Kit',
                'Surgical Kit', 'Translator', 'Thieves Tools', 'Engineering Tools'
            ];
            
            // Helper functions
            const getProficiencyBonus = (cr) => {
                if (cr <= 4) return 2;
                if (cr <= 8) return 3;
                if (cr <= 12) return 4;
                if (cr <= 16) return 5;
                if (cr <= 20) return 6;
                return 7;
            };
            
            const getModifier = (score) => {
                return Math.floor((score - 10) / 2);
            };
            
            const getMissionPoints = () => {
                return npc.cr * 2;
            };
            
            const getSpentMP = () => {
                return npc.feats.reduce((total, featName) => {
                    for (const category of Object.values(featsByCategory)) {
                        const feat = category.find(f => f.name === featName);
                        if (feat) return total + feat.cost;
                    }
                    return total;
                }, 0);
            };
            
            const getRemainingMP = () => {
                return getMissionPoints() - getSpentMP();
            };
            
            const getMaxSkillProficiencies = () => {
                let count = 2;
                if (npc.cr >= 3) count++;
                if (npc.cr >= 9) count++;
                if (npc.cr >= 15) count++;
                return count;
            };
            
            const getMaxBeastAbilities = () => {
                return Math.max(1, Math.floor(npc.cr / 2));
            };
            
            const getAttackBonus = () => {
                if (npc.race === 'Beast') return 'N/A (Beasts use natural attacks)';
                if (npc.cr >= 17) return 'Attack Ace (4x damage dice)';
                if (npc.cr >= 11) return 'Attack Veteran (3x damage dice)';
                if (npc.cr >= 5) return 'Attack Specialist (2x damage dice)';
                return 'None';
            };
            
            const checkFeatRequirements = (feat) => {
                if (!feat.requirements) return true;
                
                const reqs = feat.requirements.toLowerCase();
                
                // Check ability score requirements
                const abilityChecks = [
                    { name: 'strength', key: 'strength' },
                    { name: 'dexterity', key: 'dexterity' },
                    { name: 'constitution', key: 'constitution' },
                    { name: 'intelligence', key: 'intelligence' },
                    { name: 'wisdom', key: 'wisdom' },
                    { name: 'charisma', key: 'charisma' }
                ];
                
                for (const check of abilityChecks) {
                    if (reqs.includes(check.name)) {
                        const regex = new RegExp(`${check.name} (\\d+)\\+`);
                        const match = reqs.match(regex);
                        if (match) {
                            const finalScore = parseInt(npc.abilityScores[check.key]) + (parseInt(npc.bonusAttributes[check.key]) || 0);
                            if (finalScore < parseInt(match[1])) return false;
                        }
                    }
                }
                
                // Check level requirements
                if (reqs.includes('level 17') && npc.cr < 17) return false;
                if (reqs.includes('level 11') && npc.cr < 11) return false;
                if (reqs.includes('level 5') && npc.cr < 5) return false;
                
                // Check skill requirements
                const skillReqs = skills.filter(skill => reqs.includes(skill.toLowerCase()));
                for (const skill of skillReqs) {
                    if (!npc.skillProficiencies.includes(skill)) return false;
                }
                
                // Check for other feat requirements
                const featChecks = [
                    { req: 'attack specialist', feat: 'Attack Specialist' },
                    { req: 'attack veteran', feat: 'Attack Veteran' },
                    { req: 'critical focus', feat: 'Critical Focus' },
                    { req: 'hold together', feat: 'Hold Together' },
                    { req: 'iron grip', feat: 'Iron Grip' },
                    { req: 'sniper techniques', feat: 'Sniper Techniques' }
                ];
                
                for (const check of featChecks) {
                    if (reqs.includes(check.req) && !npc.feats.includes(check.feat)) return false;
                }
                
                // Check for ability requirements
                const abilityReqChecks = [
                    { req: 'inspire ability', feat: 'Advanced Training: Diplomat' },
                    { req: 'jury rig ability', feat: 'Advanced Training: Engineer' },
                    { req: 'first aid ability', feat: 'Advanced Training: Medic' },
                    { req: 'eureka ability', feat: 'Advanced Training: Scientist' },
                    { req: 'survivalist ability', feat: 'Advanced Training: Scout' },
                    { req: 'tactical flexibility ability', feat: 'Advanced Training: Soldier' }
                ];
                
                for (const check of abilityReqChecks) {
                    if (reqs.includes(check.req) && !npc.feats.includes(check.feat)) return false;
                }
                
                // Check for tactic feats requirement
                if (reqs.includes('two tactic feats')) {
                    const tacticCount = npc.feats.filter(f => 
                        featsByCategory['Tactic'].some(tactic => tactic.name === f)
                    ).length;
                    if (tacticCount < 2) return false;
                }
                
                return true;
            };
            
            // Filter feats based on search query
            const filterFeats = (feats) => {
                if (!featSearchQuery.trim()) return feats;
                
                const query = featSearchQuery.toLowerCase();
                return feats.filter(feat => 
                    feat.name.toLowerCase().includes(query) ||
                    feat.description.toLowerCase().includes(query) ||
                    (feat.requirements && feat.requirements.toLowerCase().includes(query))
                );
            };
            
            // Update derived stats
            useEffect(() => {
                const finalStr = npc.abilityScores.strength + (parseInt(npc.bonusAttributes.strength) || 0);
                const finalDex = npc.abilityScores.dexterity + (parseInt(npc.bonusAttributes.dexterity) || 0);
                const finalCon = npc.abilityScores.constitution + (parseInt(npc.bonusAttributes.constitution) || 0);
                const finalWis = npc.abilityScores.wisdom + (parseInt(npc.bonusAttributes.wisdom) || 0);
                
                const baseHP = 10 + (npc.cr * 5) + (getModifier(finalCon) * npc.cr);
                const baseAC = 10 + getModifier(finalDex);
                const initiative = Math.max(getModifier(finalDex), getModifier(finalWis));
                
                setNpc(prev => ({
                    ...prev,
                    hp: baseHP,
                    ac: baseAC,
                    profBonus: getProficiencyBonus(npc.cr),
                    initiative: initiative
                }));
            }, [npc.cr, npc.abilityScores, npc.bonusAttributes]);
            
            // Point buy system
            const pointBuyCost = {
                8: 0, 9: 1, 10: 2, 11: 3, 12: 4, 13: 5, 14: 7, 15: 9
            };
            
            const getPointsSpent = () => {
                return Object.values(npc.abilityScores).reduce((sum, score) => {
                    return sum + (pointBuyCost[score] || 0);
                }, 0);
            };
            
            const updateAbilityScore = (ability, value) => {
                const newValue = Math.max(8, Math.min(15, value));
                setNpc(prev => ({
                    ...prev,
                    abilityScores: {
                        ...prev.abilityScores,
                        [ability]: newValue
                    }
                }));
            };
            
            const exportNPC = () => {
                const getFinalScore = (ability) => {
                    return npc.abilityScores[ability] + (parseInt(npc.bonusAttributes[ability]) || 0);
                };
                
                let sheet = `STARGATE RPG NPC STAT BLOCK
=============================
Name: ${npc.name || 'Unnamed NPC'}
Race: ${npc.race}${npc.race === 'Beast' ? ` (${npc.type || 'Untyped'})` : ''}
Challenge Rating: ${npc.cr}

ATTRIBUTES
STR: ${getFinalScore('strength')} (${getModifier(getFinalScore('strength')) >= 0 ? '+' : ''}${getModifier(getFinalScore('strength'))})
DEX: ${getFinalScore('dexterity')} (${getModifier(getFinalScore('dexterity')) >= 0 ? '+' : ''}${getModifier(getFinalScore('dexterity'))})
CON: ${getFinalScore('constitution')} (${getModifier(getFinalScore('constitution')) >= 0 ? '+' : ''}${getModifier(getFinalScore('constitution'))})
INT: ${getFinalScore('intelligence')} (${getModifier(getFinalScore('intelligence')) >= 0 ? '+' : ''}${getModifier(getFinalScore('intelligence'))})
WIS: ${getFinalScore('wisdom')} (${getModifier(getFinalScore('wisdom')) >= 0 ? '+' : ''}${getModifier(getFinalScore('wisdom'))})
CHA: ${getFinalScore('charisma')} (${getModifier(getFinalScore('charisma')) >= 0 ? '+' : ''}${getModifier(getFinalScore('charisma'))})

COMBAT STATS
Armor Class: ${npc.ac}
Hit Points: ${npc.hp}
Speed: ${npc.speed}m
Proficiency Bonus: +${npc.profBonus}
Initiative: ${npc.initiative >= 0 ? '+' : ''}${npc.initiative}

SKILLS
${npc.skillProficiencies.join(', ') || 'None'}

ATTACK BONUS
${getAttackBonus()}${npc.attackSpecialization ? ` (${npc.attackSpecialization})` : ''}

`;
                
                if (npc.race === 'Beast') {
                    sheet += `\nBEAST ABILITIES\n`;
                    npc.beastAbilities.forEach(ability => {
                        const selection = npc.beastAbilitySelections[ability];
                        sheet += `• ${ability}${selection ? ` (${selection})` : ''}\n`;
                    });
                } else {
                    sheet += `\nFEATS (${getSpentMP()}/${getMissionPoints()} MP Spent)\n`;
                    npc.feats.forEach(feat => {
                        const selection = npc.featSelections[feat];
                        sheet += `• ${feat}${selection ? ` (${selection})` : ''}\n`;
                    });
                }
                
                sheet += `\n=============================`;
                
                const element = document.createElement('a');
                const file = new Blob([sheet], { type: 'text/plain' });
                element.href = URL.createObjectURL(file);
                element.download = `${npc.name || 'npc'}_cr${npc.cr}.txt`;
                document.body.appendChild(element);
                element.click();
                document.body.removeChild(element);
            };
            
            const renderSelection = (itemName, isBeast = false) => {
                const item = isBeast
                    ? Object.values(beastAbilitiesByCategory).flat().find(a => a.name === itemName)
                    : Object.values(featsByCategory).flat().find(f => f.name === itemName);
                
                if (!item?.needsSelection) return null;
                
                let options = [];
                const selectionType = item.needsSelection;
                
                if (selectionType === 'attribute') {
                    options = selectionOptions.attributes;
                } else if (selectionType === 'environment') {
                    options = selectionOptions.environments;
                } else if (selectionType === 'sense') {
                    options = selectionOptions.senses;
                } else if (selectionType === 'condition') {
                    options = selectionOptions.conditions;
                } else if (selectionType === 'maneuver') {
                    options = selectionOptions.maneuvers;
                } else if (selectionType === 'combatSkill') {
                    options = selectionOptions.combatSkills;
                } else if (selectionType === 'skill') {
                    if (itemName === 'Exceptional Expertise') {
                        options = npc.skillProficiencies;
                    } else {
                        options = skills.filter(s => !npc.skillProficiencies.includes(s));
                    }
                } else if (selectionType === 'tool') {
                    options = toolTypes;
                } else if (selectionType === 'weapon') {
                    options = weaponTypes;
                }
                
                const value = isBeast ? npc.beastAbilitySelections[itemName] : npc.featSelections[itemName];
                
                return (
                    <select
                        value={value || ''}
                        onChange={(e) => {
                            if (isBeast) {
                                setNpc(prev => ({
                                    ...prev,
                                    beastAbilitySelections: {
                                        ...prev.beastAbilitySelections,
                                        [itemName]: e.target.value
                                    }
                                }));
                            } else {
                                setNpc(prev => ({
                                    ...prev,
                                    featSelections: {
                                        ...prev.featSelections,
                                        [itemName]: e.target.value
                                    }
                                }));
                            }
                        }}
                        className="mt-2 w-full px-2 py-1 bg-gray-900 border border-gray-700 rounded text-xs text-white"
                        onClick={(e) => e.stopPropagation()}
                    >
                        <option value="">Select {selectionType}...</option>
                        {options.map(opt => (
                            <option key={opt} value={opt}>{opt}</option>
                        ))}
                    </select>
                );
            };
            
            return (
                <div className="min-h-screen bg-gradient-to-br from-gray-900 via-blue-900 to-purple-900 p-4">
                    <div className="max-w-7xl mx-auto">
                        <div className="bg-gray-800/90 backdrop-blur-sm rounded-lg shadow-2xl border border-blue-500/30">
                            {/* Header */}
                            <div className="bg-gradient-to-r from-blue-600 to-purple-600 p-6 rounded-t-lg">
                                <h1 className="text-3xl font-bold text-white">
                                    Stargate RPG NPC Builder
                                </h1>
                                <p className="text-blue-100 mt-2">Create NPCs and Beasts for your campaigns</p>
                            </div>
                            
                            <div className="p-6 space-y-6">
                                {/* NPC Name */}
                                <div className="bg-gray-700/50 rounded-lg p-4">
                                    <label className="block text-sm font-medium text-gray-300 mb-2">
                                        NPC Name
                                    </label>
                                    <input
                                        type="text"
                                        value={npc.name}
                                        onChange={(e) => setNpc(prev => ({ ...prev, name: e.target.value }))}
                                        className="w-full px-4 py-2 bg-gray-800 border border-gray-600 rounded-lg text-white focus:border-blue-500 focus:outline-none"
                                        placeholder="Enter NPC name..."
                                    />
                                </div>
                                
                                {/* Race Selection */}
                                <div className="bg-gray-700/50 rounded-lg p-4">
                                    <label className="block text-sm font-medium text-gray-300 mb-2">
                                        Select Race
                                    </label>
                                    <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                                        {races.map(race => (
                                            <button
                                                key={race}
                                                onClick={() => setNpc(prev => ({ 
                                                    ...prev, 
                                                    race, 
                                                    type: '',
                                                    feats: [],
                                                    featSelections: {},
                                                    beastAbilities: [],
                                                    beastAbilitySelections: {}
                                                }))}
                                                className={`p-3 rounded-lg border-2 transition-all ${
                                                    npc.race === race
                                                        ? 'border-blue-500 bg-blue-500/20 text-white'
                                                        : 'border-gray-600 bg-gray-800 text-gray-300 hover:border-gray-500'
                                                }`}
                                            >
                                                <div className="font-semibold flex items-center gap-2 justify-center">
                                                    {race === 'Beast'}
                                                    {race === 'Human'}
                                                    {race === 'Jaffa'}
                                                    {race === 'NPC Race'}
                                                    {race}
                                                </div>
                                            </button>
                                        ))}
                                    </div>
                                </div>
                                
                                {/* Beast Type Selection */}
                                {npc.race === 'Beast' && (
                                    <div className="bg-yellow-500/10 border-2 border-yellow-500/50 rounded-lg p-4">
                                        <label className="block text-sm font-medium text-yellow-300 mb-2">
                                            Select Beast Type
                                        </label>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
                                            {beastTypes.map(type => (
                                                <button
                                                    key={type.name}
                                                    onClick={() => setNpc(prev => ({ ...prev, type: type.name }))}
                                                    className={`p-3 text-left rounded border transition-all ${
                                                        npc.type === type.name
                                                            ? 'border-yellow-500 bg-yellow-500/20'
                                                            : 'border-gray-600 bg-gray-800 hover:border-gray-500'
                                                    }`}
                                                >
                                                    <div className="font-semibold text-sm text-white">{type.name}</div>
                                                    <div className="text-xs text-gray-400">{type.description}</div>
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                )}
                                
                                {/* Challenge Rating Selection */}
                                <div className="bg-gray-700/50 rounded-lg p-4">
                                    <label className="block text-sm font-medium text-gray-300 mb-2">
                                        Challenge Rating (CR)
                                    </label>
                                    <div className="flex items-center gap-4">
                                        <button
                                            onClick={() => setNpc(prev => ({ ...prev, cr: Math.max(1, prev.cr - 1) }))}
                                            className="w-8 h-8 bg-gray-700 hover:bg-gray-600 rounded flex items-center justify-center text-white"
                                        >
                                            <Icons.Minus />
                                        </button>
                                        <input
                                            type="range"
                                            min="1"
                                            max="20"
                                            value={npc.cr}
                                            onChange={(e) => setNpc(prev => ({ ...prev, cr: parseInt(e.target.value) }))}
                                            className="flex-1"
                                        />
                                        <button
                                            onClick={() => setNpc(prev => ({ ...prev, cr: Math.min(20, prev.cr + 1) }))}
                                            className="w-8 h-8 bg-gray-700 hover:bg-gray-600 rounded flex items-center justify-center text-white"
                                        >
                                            <Icons.Plus />
                                        </button>
                                        <div className="bg-gray-800 px-4 py-2 rounded-lg border border-gray-600 min-w-[60px] text-center">
                                            <span className="text-xl font-bold text-white">{npc.cr}</span>
                                        </div>
                                    </div>
                                    <div className="mt-2 text-xs text-gray-400">
                                        Mission Points Available: {getMissionPoints()} MP
                                    </div>
                                </div>
                                
                                {/* Ability Scores */}
                                <div className="bg-gray-700/50 rounded-lg p-4">
                                    <div className="flex justify-between items-center mb-4">
                                        <label className="text-sm font-medium text-gray-300">
                                            Ability Scores (Point Buy) - Base Values
                                        </label>
                                        <span className={`text-sm px-3 py-1 rounded-full ${
                                            getPointsSpent() > 27 ? 'bg-red-500/20 text-red-300' : 'bg-green-500/20 text-green-300'
                                        }`}>
                                            Points: {getPointsSpent()}/27
                                        </span>
                                    </div>
                                    
                                    <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                                        {Object.entries(npc.abilityScores).map(([ability, score]) => {
                                            const bonus = parseInt(npc.bonusAttributes[ability]) || 0;
                                            const finalScore = score + bonus;
                                            
                                            return (
                                                <div key={ability} className="bg-gray-800 rounded-lg p-3">
                                                    <div className="flex justify-between items-center mb-2">
                                                        <span className="text-xs text-gray-400 capitalize">{ability}</span>
                                                        <span className="text-xs text-blue-300">
                                                            Final: {finalScore} ({getModifier(finalScore) >= 0 ? '+' : ''}{getModifier(finalScore)})
                                                        </span>
                                                    </div>
                                                    <div className="flex items-center gap-2">
                                                        <button
                                                            onClick={() => updateAbilityScore(ability, score - 1)}
                                                            className="w-8 h-8 bg-gray-700 hover:bg-gray-600 rounded text-white"
                                                            disabled={score <= 8}
                                                        >
                                                            -
                                                        </button>
                                                        <div className="flex-1 text-center">
                                                            <div className="text-lg font-bold text-white">{score}</div>
                                                            {bonus !== 0 && (
                                                                <div className="text-xs text-green-400">+{bonus}</div>
                                                            )}
                                                        </div>
                                                        <button
                                                            onClick={() => updateAbilityScore(ability, score + 1)}
                                                            className="w-8 h-8 bg-gray-700 hover:bg-gray-600 rounded text-white"
                                                            disabled={score >= 15 || getPointsSpent() >= 27}
                                                        >
                                                            +
                                                        </button>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                                
                                {/* Bonus Attributes */}
                                <div className="bg-gray-700/50 rounded-lg p-4">
                                    <label className="text-sm font-medium text-gray-300 mb-2">
                                        Bonus Attributes (Optional)
                                    </label>
                                    <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
                                        {Object.entries(npc.bonusAttributes).map(([ability, bonus]) => (
                                            <div key={ability} className="flex items-center gap-2">
                                                <span className="text-xs text-gray-400 capitalize w-20">{ability}:</span>
                                                <input
                                                    type="number"
                                                    value={bonus}
                                                    onChange={(e) => setNpc(prev => ({
                                                        ...prev,
                                                        bonusAttributes: {
                                                            ...prev.bonusAttributes,
                                                            [ability]: e.target.value
                                                        }
                                                    }))}
                                                    placeholder=""
                                                    className="w-20 px-2 py-1 bg-gray-800 border border-gray-600 rounded text-white text-sm"
                                                    min="-5"
                                                    max="10"
                                                />
                                            </div>
                                        ))}
                                    </div>
                                </div>
                                
                                {/* Skill Proficiencies */}
                                <div className="bg-gray-700/50 rounded-lg p-4">
                                    <label className="text-sm font-medium text-gray-300 mb-2">
                                        Skill Proficiencies ({npc.skillProficiencies.length}/{getMaxSkillProficiencies()})
                                    </label>
                                    <div className="text-xs text-gray-400 mb-3">
                                        Base: 2 skills{npc.cr >= 3 && ', +1 at CR 3'}{npc.cr >= 9 && ', +1 at CR 9'}{npc.cr >= 15 && ', +1 at CR 15'}
                                    </div>
                                    <div className="grid grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-2">
                                        {skills.map(skill => {
                                            const isSelected = npc.skillProficiencies.includes(skill);
                                            const maxReached = npc.skillProficiencies.length >= getMaxSkillProficiencies();
                                            
                                            return (
                                                <button
                                                    key={skill}
                                                    onClick={() => {
                                                        setNpc(prev => {
                                                            if (isSelected) {
                                                                return {
                                                                    ...prev,
                                                                    skillProficiencies: prev.skillProficiencies.filter(s => s !== skill)
                                                                };
                                                            } else if (!maxReached) {
                                                                return {
                                                                    ...prev,
                                                                    skillProficiencies: [...prev.skillProficiencies, skill]
                                                                };
                                                            }
                                                            return prev;
                                                        });
                                                    }}
                                                    disabled={!isSelected && maxReached}
                                                    className={`p-2 rounded text-xs transition-all ${
                                                        isSelected
                                                            ? 'bg-green-500/20 border border-green-500 text-white'
                                                            : 'bg-gray-800 border border-gray-600 text-gray-300 hover:border-gray-500 disabled:opacity-50'
                                                    }`}
                                                >
                                                    {skill}
                                                </button>
                                            );
                                        })}
                                    </div>
                                </div>
                                
                                {/* Attack Specialization */}
                                {npc.cr >= 5 && npc.race !== 'Beast' && (
                                    <div className="bg-gray-700/50 rounded-lg p-4">
                                        <div className="flex items-center gap-2 mb-3">
                                            <label className="text-sm font-medium text-gray-300">
                                                Attack Specialization - {getAttackBonus()}
                                            </label>
                                        </div>
                                        <select
                                            value={npc.attackSpecialization}
                                            onChange={(e) => setNpc(prev => ({ ...prev, attackSpecialization: e.target.value }))}
                                            className="w-full px-4 py-2 bg-gray-800 border border-gray-600 rounded-lg text-white"
                                        >
                                            <option value="">Select weapon type...</option>
                                            {weaponTypes.map(weapon => (
                                                <option key={weapon} value={weapon}>{weapon}</option>
                                            ))}
                                        </select>
                                    </div>
                                )}
                                
                                {/* Beast Abilities */}
                                {npc.race === 'Beast' && (
                                    <div className="bg-yellow-500/10 border-2 border-yellow-500/50 rounded-lg p-4">
                                        <h3 className="text-lg font-semibold text-yellow-300 mb-3">
                                            Beast Abilities ({npc.beastAbilities.length}/{getMaxBeastAbilities()})
                                        </h3>
                                        <p className="text-sm text-gray-400 mb-4">
                                            Select up to {getMaxBeastAbilities()} abilities (half CR, minimum 1)
                                        </p>
                                        
                                        <div className="space-y-2">
                                            {Object.entries(beastAbilitiesByCategory).map(([category, abilities]) => {
                                                return (
                                                    <div key={category} className="border border-gray-600 rounded-lg overflow-hidden">
                                                        <button
                                                            onClick={() => setExpandedBeastCategories(prev => ({
                                                                ...prev,
                                                                [category]: !prev[category]
                                                            }))}
                                                            className="w-full px-4 py-2 bg-gray-700 hover:bg-gray-600 transition-colors flex items-center justify-between"
                                                        >
                                                            <span className="font-semibold text-sm text-white flex items-center gap-2">
                                                                {category}
                                                                <span className="text-xs text-gray-400">({abilities.length})</span>
                                                            </span>
                                                            <Icons.ChevronDown className={`w-4 h-4 text-gray-400 transition-transform ${
                                                                expandedBeastCategories[category] ? 'rotate-180' : ''
                                                            }`} />
                                                        </button>
                                                        
                                                        {expandedBeastCategories[category] && (
                                                            <div className="p-2 bg-gray-800 grid grid-cols-1 md:grid-cols-2 gap-2">
                                                                {abilities.map(ability => {
                                                                    const isSelected = npc.beastAbilities.includes(ability.name);
                                                                    const maxReached = npc.beastAbilities.length >= getMaxBeastAbilities();
                                                                    
                                                                    return (
                                                                        <button
                                                                            key={ability.name}
                                                                            onClick={() => {
                                                                                setNpc(prev => {
                                                                                    if (isSelected) {
                                                                                        const newSelections = { ...prev.beastAbilitySelections };
                                                                                        delete newSelections[ability.name];
                                                                                        return {
                                                                                            ...prev,
                                                                                            beastAbilities: prev.beastAbilities.filter(a => a !== ability.name),
                                                                                            beastAbilitySelections: newSelections
                                                                                        };
                                                                                    } else if (!maxReached) {
                                                                                        return {
                                                                                            ...prev,
                                                                                            beastAbilities: [...prev.beastAbilities, ability.name]
                                                                                        };
                                                                                    }
                                                                                    return prev;
                                                                                });
                                                                            }}
                                                                            disabled={!isSelected && maxReached}
                                                                            className={`p-3 text-left rounded border transition-all ${
                                                                                isSelected
                                                                                    ? 'border-yellow-500 bg-yellow-500/20'
                                                                                    : 'border-gray-600 bg-gray-700 hover:border-gray-500 disabled:opacity-50'
                                                                            }`}
                                                                        >
                                                                            <div className="flex justify-between items-start">
                                                                                <div className="flex-1">
                                                                                    <div className="font-semibold text-sm text-white">{ability.name}</div>
                                                                                    <div className="text-xs text-gray-400 mt-1">{ability.description}</div>
                                                                                    {isSelected && renderSelection(ability.name, true)}
                                                                                </div>
                                                                                {isSelected && (
                                                                                    <div className="ml-2 text-yellow-400">✓</div>
                                                                                )}
                                                                            </div>
                                                                        </button>
                                                                    );
                                                                })}
                                                            </div>
                                                        )}
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                )}
                                
                                {/* Feats */}
                                {npc.race !== 'Beast' && (
                                    <div className="bg-gray-700/50 rounded-lg p-4">
                                        <h3 className="text-lg font-semibold text-gray-300 mb-3">
                                            Feats Selection
                                        </h3>
                                        <div className="mb-4 flex justify-between items-center">
                                            <span className="text-sm text-gray-400">
                                                Mission Points: {getRemainingMP()} MP remaining ({getSpentMP()}/{getMissionPoints()} spent)
                                            </span>
                                        </div>
                                        
                                        {/* Search Bar */}
                                        <div className="mb-4">
                                            <div className="relative">
                                                <Icons.Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400" />
                                                <input
                                                    type="text"
                                                    value={featSearchQuery}
                                                    onChange={(e) => setFeatSearchQuery(e.target.value)}
                                                    placeholder="Search feats by name, description, or requirements..."
                                                    className="w-full pl-10 pr-4 py-2 bg-gray-800 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:border-blue-500 focus:outline-none"
                                                />
                                            </div>
                                        </div>
                                        
                                        {/* Category Tabs */}
                                        <div className="flex flex-wrap gap-2 mb-4">
                                            {Object.keys(featsByCategory).map(category => (
                                                <button
                                                    key={category}
                                                    onClick={() => setSelectedFeatCategory(category)}
                                                    className={`px-4 py-2 rounded-lg font-medium text-sm transition-all ${
                                                        selectedFeatCategory === category
                                                            ? 'bg-purple-600 text-white shadow-lg'
                                                            : 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                                                    }`}
                                                >
                                                    {category}
                                                </button>
                                            ))}
                                        </div>
                                        
                                        {/* Category Description */}
                                        <div className="mb-4 text-sm text-gray-400">
                                            {selectedFeatCategory === 'General' && 'Broad abilities available to all characters, covering various aspects of character development.'}
                                            {selectedFeatCategory === 'Combat - General' && 'General combat improvements for all fighting styles.'}
                                            {selectedFeatCategory === 'Combat - Melee' && 'Specialized abilities for close-quarters combat.'}
                                            {selectedFeatCategory === 'Combat - Ranged' && 'Enhancements for ranged weapon combat.'}
                                            {selectedFeatCategory === 'Inspiration' && 'Abilities that enhance your Inspire feature.'}
                                            {selectedFeatCategory === 'Modification' && 'Equipment and item modification abilities.'}
                                            {selectedFeatCategory === 'Procedure' && 'Medical and scientific procedure abilities.'}
                                            {selectedFeatCategory === 'Discovery' && 'Scientific discovery and research abilities.'}
                                            {selectedFeatCategory === 'Field Hack' && 'Survival and field operation abilities.'}
                                            {selectedFeatCategory === 'Tactic' && 'Team coordination and tactical abilities.'}
                                            {selectedFeatCategory === 'Downtime' && 'Abilities that provide benefits during downtime.'}
                                        </div>
                                        
                                        {/* Available Feats Grid - Made taller */}
                                        <div className="bg-gray-800 rounded-lg p-4 mb-4">
                                            <h4 className="text-sm font-semibold text-gray-300 mb-3">
                                                {selectedFeatCategory} Feats
                                                {featSearchQuery && ` (Filtered)`}
                                            </h4>
                                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3" style={{ maxHeight: '600px', overflowY: 'auto' }}>
                                                {filterFeats(featsByCategory[selectedFeatCategory] || []).map(feat => {
                                                    const isSelected = npc.feats.includes(feat.name);
                                                    const canAfford = getRemainingMP() >= feat.cost;
                                                    const meetsRequirements = checkFeatRequirements(feat);
                                                    const canSelect = !isSelected && canAfford && meetsRequirements;
                                                    
                                                    return (
                                                        <button
                                                            key={feat.name}
                                                            onClick={() => {
                                                                if (!isSelected && canSelect) {
                                                                    setNpc(prev => ({
                                                                        ...prev,
                                                                        feats: [...prev.feats, feat.name]
                                                                    }));
                                                                }
                                                            }}
                                                            disabled={isSelected || !canSelect}
                                                            className={`p-3 rounded-lg border-2 transition-all text-left ${
                                                                isSelected
                                                                    ? 'border-gray-600 bg-gray-700/50 opacity-50'
                                                                    : canSelect
                                                                    ? 'border-gray-600 bg-gray-700 hover:border-purple-500 hover:bg-purple-500/10 cursor-pointer'
                                                                    : 'border-gray-700 bg-gray-800/50 opacity-40 cursor-not-allowed'
                                                            }`}
                                                        >
                                                            <div className="flex justify-between items-start mb-2">
                                                                <span className="font-semibold text-sm text-white flex-1">{feat.name}</span>
                                                                <span className="text-xs px-2 py-1 bg-blue-500/20 text-blue-300 rounded ml-2">
                                                                    {feat.cost} MP
                                                                </span>
                                                            </div>
                                                            <div className="text-xs text-gray-400 line-clamp-2">{feat.description}</div>
                                                            {feat.requirements && (
                                                                <div className="text-xs mt-2">
                                                                    <span className={meetsRequirements ? 'text-green-400' : 'text-red-400'}>
                                                                        Req: {feat.requirements.length > 30 ? feat.requirements.substring(0, 30) + '...' : feat.requirements}
                                                                    </span>
                                                                </div>
                                                            )}
                                                            {isSelected && (
                                                                <div className="text-xs text-gray-500 mt-2">Already Selected</div>
                                                            )}
                                                        </button>
                                                    );
                                                })}
                                                {filterFeats(featsByCategory[selectedFeatCategory] || []).length === 0 && (
                                                    <div className="col-span-3 text-center text-gray-500 py-4">
                                                        No feats found matching "{featSearchQuery}"
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                        
                                        {/* Selected Feats Grid - Changed to light blue-gray */}
                                        {npc.feats.length > 0 && (
                                            <div className="bg-blue-100/10 border-2 border-blue-300/30 rounded-lg p-4">
                                                <h4 className="text-sm font-semibold text-blue-300 mb-3">
                                                    Selected Feats ({npc.feats.length})
                                                </h4>
                                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 max-h-64 overflow-y-auto">
                                                    {npc.feats.map(featName => {
                                                        let feat = null;
                                                        for (const category of Object.values(featsByCategory)) {
                                                            feat = category.find(f => f.name === featName);
                                                            if (feat) break;
                                                        }
                                                        
                                                        if (!feat) return null;
                                                        
                                                        return (
                                                            <div
                                                                key={featName}
                                                                className="p-3 rounded-lg border-2 border-blue-200/30 bg-gray-600/50 relative cursor-pointer hover:bg-gray-600/70 transition-all"
                                                                onClick={() => {
                                                                    setNpc(prev => {
                                                                        const newSelections = { ...prev.featSelections };
                                                                        delete newSelections[featName];
                                                                        return {
                                                                            ...prev,
                                                                            feats: prev.feats.filter(f => f !== featName),
                                                                            featSelections: newSelections
                                                                        };
                                                                    });
                                                                }}
                                                            >
                                                                <div className="flex justify-between items-start mb-2">
                                                                    <span className="font-semibold text-sm text-white flex-1">{feat.name}</span>
                                                                    <span className="text-xs px-2 py-1 bg-blue-600/30 text-blue-300 rounded">
                                                                        {feat.cost} MP
                                                                    </span>
                                                                </div>
                                                                <div className="text-xs text-gray-300 line-clamp-2 mb-2">{feat.description}</div>
                                                                {renderSelection(feat.name)}
                                                                <div className="text-xs text-blue-400 mt-2">Click to remove</div>
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                )}
                                
                                {/* Combat Statistics */}
                                <div className="bg-gray-700/50 rounded-lg p-4">
                                    <h3 className="text-lg font-semibold text-gray-300 mb-4">Combat Statistics</h3>
                                    
                                    <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                                        <div className="bg-gray-800 rounded-lg p-3">
                                            <div className="flex items-center gap-2 text-red-400 mb-1">
                                                <Icons.Heart className="w-4 h-4" />
                                                <span className="text-xs">Hit Points</span>
                                            </div>
                                            <div className="text-2xl font-bold text-white">{npc.hp}</div>
                                        </div>
                                        
                                        <div className="bg-gray-800 rounded-lg p-3">
                                            <div className="flex items-center gap-2 text-blue-400 mb-1">
                                                <Icons.Shield className="w-4 h-4" />
                                                <span className="text-xs">Armor Class</span>
                                            </div>
                                            <div className="text-2xl font-bold text-white">{npc.ac}</div>
                                        </div>
                                        
                                        <div className="bg-gray-800 rounded-lg p-3">
                                            <div className="flex items-center gap-2 text-yellow-400 mb-1">
                                                <Icons.Zap className="w-4 h-4" />
                                                <span className="text-xs">Initiative</span>
                                            </div>
                                            <div className="text-2xl font-bold text-white">
                                                {npc.initiative >= 0 ? '+' : ''}{npc.initiative}
                                            </div>
                                        </div>
                                        
                                        <div className="bg-gray-800 rounded-lg p-3">
                                            <div className="flex items-center gap-2 text-purple-400 mb-1">
                                                <Icons.Brain className="w-4 h-4" />
                                                <span className="text-xs">Prof. Bonus</span>
                                            </div>
                                            <div className="text-2xl font-bold text-white">+{npc.profBonus}</div>
                                        </div>
                                        
                                        <div className="bg-gray-800 rounded-lg p-3">
                                            <div className="flex items-center gap-2 text-green-400 mb-1">
                                                <Icons.Target className="w-4 h-4" />
                                                <span className="text-xs">Speed</span>
                                            </div>
                                            <div className="text-2xl font-bold text-white">{npc.speed}m</div>
                                        </div>
                                    </div>
                                </div>
                                
                                {/* Export Button */}
                                <div className="flex justify-end">
                                    <button
                                        onClick={exportNPC}
                                        disabled={!npc.race || (npc.race === 'Beast' && !npc.type)}
                                        className="px-6 py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white font-semibold rounded-lg hover:from-blue-700 hover:to-purple-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all flex items-center gap-2"
                                    >
                                        <Icons.Download className="w-5 h-5" />
                                        Export NPC
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };
        
        // Render the app
        ReactDOM.render(<StargateNPCBuilder />, document.getElementById('root'));
    </script>
</body>
</html>
